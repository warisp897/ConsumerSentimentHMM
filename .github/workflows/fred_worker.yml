name: FRED Pull Worker

on:
  schedule:
    # Run at 06:15 UTC on the 2nd day of every month
    - cron: "15 6 2 * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: fred-pull-worker
  cancel-in-progress: false

jobs:
  run-worker:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Set up R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            any::fredr
            any::dplyr
            any::tidyr
            any::purrr
            any::readr
            any::lubridate

      - name: Run FRED pull
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          FRED_START: "1980-01-01"
          OUT_DIR: "data"
        run: |
          Rscript worker/pull_fred_indicators.R

      - name: Append run event (NDJSON)
        if: always()
        run: |
          mkdir -p data
          TS="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          STATUS="${{ job.status }}"
          SHA="${GITHUB_SHA}"
          RUN_ID="${GITHUB_RUN_ID}"
          RUN_ATTEMPT="${GITHUB_RUN_ATTEMPT}"

          # Count rows if the file exists
          ROWS="NA"
          if [ -f "data/fred_raw_long.csv" ]; then
            # subtract header line
            ROWS=$(($(wc -l < data/fred_raw_long.csv) - 1))
          fi

          printf '{"timestamp_utc":"%s","workflow":"FRED Pull Worker","status":"%s","git_sha":"%s","run_id":%s,"run_attempt":%s,"rows_long":%s}\n' \
            "$TS" "$STATUS" "$SHA" "$RUN_ID" "$RUN_ATTEMPT" "$ROWS" >> data/worker_runs.ndjson

      - name: Commit & push changes
        run: |
          # If nothing changed, do nothing.
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          pwd
          ls -la
          ls -la data || true
          git status --porcelain
          git add -A data
          git status --porcelain

          git add data/*.csv data/*.ndjson || true

          # Avoid failing if add matched nothing
          if git diff --cached --quiet; then
            echo "Nothing staged after git add."
            exit 0
          fi

          git commit -m "worker: monthly FRED pull (auto)"
          git push
